{
    "name": "#{DATABRICKS_ENVIRONMENT_LOWER}#_full_v2_receita_federal_job",
    "description": "Job to execute receita_federal full pipeline",
    "format": "MULTI_TASK",
    "max_concurrent_runs": 1,
    "run_as": {
        "service_principal_name": "#{DATABRICKS_CLIENT_ID}#"
    },
    "email_notifications": {
        "no_alert_for_skipped_runs": false
    },
    "webhook_notifications": {
        "on_start": [
            {
                "id": "#{DATABRICKS_SLACK_WEBHOOK}#"
            }
        ],
        "on_success": [
            {
                "id": "#{DATABRICKS_SLACK_WEBHOOK}#"
            }
        ],
        "on_failure": [
            {
                "id": "#{DATABRICKS_SLACK_WEBHOOK}#"
            }
        ],
        "on_duration_warning_threshold_exceeded": [
            {
                "id": "#{DATABRICKS_SLACK_WEBHOOK}#"
            }
        ]
    },
    "notification_settings": {
        "no_alert_for_skipped_runs": false,
        "no_alert_for_canceled_runs": false
    },
    "tags": {
        "job_tag": "job_tag_value"
    },
    "parameters": [
        {
            "name": "job_param",
            "default": "job_param_value"
        }
    ],
    "timeout_seconds": 2400,
    "health": {
        "rules": [
            {
                "metric": "RUN_DURATION_SECONDS",
                "op": "GREATER_THAN",
                "value": 1200
            }
        ]
    },
    "schedule": {
        "quartz_cron_expression": "#{DATABRICKS_JOB_RECEITA_FEDERAL_JOB_SCHEDULE_CRON}#",
        "timezone_id": "America/Sao_Paulo",
        "pause_status": "#{DATABRICKS_JOB_RECEITA_FEDERAL_JOB_SCHEDULE_STATUS}#"
    },
    "tasks": [
        {
            "task_key": "#{DATABRICKS_ENVIRONMENT_LOWER}#_raw_receita_federal_task",
            "notebook_task": {
                "notebook_path": "/#{DATABRICKS_ENVIRONMENT_LOWER}#/01-raw/receita_federal/raw.receita_federal_customers",
                "source": "WORKSPACE"
            },
            "run_if": "ALL_SUCCESS",
            "max_retries": 1,
            "min_retry_interval_millis": 900000,
            "retry_on_timeout": true,
            "timeout_seconds": 1800,
            "health": {
                "rules": [
                    {
                        "metric": "RUN_DURATION_SECONDS",
                        "op": "GREATER_THAN",
                        "value": 900
                    }
                ]
            },
            "email_notifications": {},
            "notification_settings": {
                "no_alert_for_skipped_runs": false,
                "no_alert_for_canceled_runs": false,
                "alert_on_last_attempt": false
            },
            "webhook_notifications": {
                "on_start": [
                    {
                        "id": "#{DATABRICKS_SLACK_WEBHOOK}#"
                    }
                ],
                "on_success": [
                    {
                        "id": "#{DATABRICKS_SLACK_WEBHOOK}#"
                    }
                ],
                "on_failure": [
                    {
                        "id": "#{DATABRICKS_SLACK_WEBHOOK}#"
                    }
                ],
                "on_duration_warning_threshold_exceeded": [
                    {
                        "id": "#{DATABRICKS_SLACK_WEBHOOK}#"
                    }
                ]
            },
            "job_cluster_key": "#{DATABRICKS_ENVIRONMENT_LOWER}#_full_v2_receita_federal_cluster"
        },
        {
            "task_key": "#{DATABRICKS_ENVIRONMENT_LOWER}#_bronze_receita_federal_task",
            "depends_on": [
                {
                    "task_key": "#{DATABRICKS_ENVIRONMENT_LOWER}#_raw_receita_federal_task"
                }
            ],
            "run_if": "ALL_SUCCESS",
            "notebook_task": {
                "notebook_path": "/#{DATABRICKS_ENVIRONMENT_LOWER}#/02-bronze/receita_federal/bronze.receita_federal_customers",
                "source": "WORKSPACE"
            },
            "max_retries": 1,
            "min_retry_interval_millis": 3600000,
            "retry_on_timeout": false,
            "timeout_seconds": 1200,
            "health": {
                "rules": [
                    {
                        "metric": "RUN_DURATION_SECONDS",
                        "op": "GREATER_THAN",
                        "value": 600
                    }
                ]
            },
            "email_notifications": {},
            "notification_settings": {
                "no_alert_for_skipped_runs": false,
                "no_alert_for_canceled_runs": false,
                "alert_on_last_attempt": false
            },
            "webhook_notifications": {
                "on_start": [
                    {
                        "id": "#{DATABRICKS_SLACK_WEBHOOK}#"
                    }
                ],
                "on_success": [
                    {
                        "id": "#{DATABRICKS_SLACK_WEBHOOK}#"
                    }
                ],
                "on_failure": [
                    {
                        "id": "#{DATABRICKS_SLACK_WEBHOOK}#"
                    }
                ],
                "on_duration_warning_threshold_exceeded": [
                    {
                        "id": "#{DATABRICKS_SLACK_WEBHOOK}#"
                    }
                ]
            },
            "job_cluster_key": "#{DATABRICKS_ENVIRONMENT_LOWER}#_full_v2_receita_federal_cluster"
        }
    ],
    "job_clusters": [
        {
            "job_cluster_key": "#{DATABRICKS_ENVIRONMENT_LOWER}#_full_v2_receita_federal_cluster",
            "new_cluster": {
                "spark_version": "13.3.x-scala2.12",
                "azure_attributes": {
                    "first_on_demand": 1,
                    "availability": "SPOT_WITH_FALLBACK_AZURE",
                    "spot_bid_max_price": -1
                },
                "custom_tags": {
                    "cost-center": "0000021",
                    "app": "databricks",
                    "env": "#{DATABRICKS_ENVIRONMENT_LOWER}#",
                    "project": "databricks-flow-sample",
                    "github-org": "ThiagoBarradas",
                    "github-repo": "databricks-flow-sample",
                    "owner": "ThiagoBarradas",
                    "support": "ThiagoBarradas"
                },
                "node_type_id": "#{DATABRICKS_JOB_RECEITA_FEDERAL_JOB_CLUSTER_NODE_TYPE}#",
                "driver_node_type_id": "#{DATABRICKS_JOB_RECEITA_FEDERAL_JOB_CLUSTER_DRIVER_TYPE}#",
                "spark_env_vars": {
                    "PYSPARK_PYTHON": "/databricks/python3/bin/python3",
                    "ENVIRONMENT_CLUSTER": "#{DATABRICKS_ENVIRONMENT_LOWER}#",
                    "DATABRICKS_WORKSPACE_PATH": "#{DATABRICKS_WORKSPACE_PATH}#"
                },
                "enable_elastic_disk": true,
                "data_security_mode": "SINGLE_USER",
                "runtime_engine": "PHOTON",
                "autoscale": {
                    "min_workers": #{DATABRICKS_JOB_RECEITA_FEDERAL_JOB_CLUSTER_AUTOSCALE_MIN_WORKER}#,
                    "max_workers": #{DATABRICKS_JOB_RECEITA_FEDERAL_JOB_CLUSTER_AUTOSCALE_MAX_WORKER}#
                }
            }
        }
    ]
}